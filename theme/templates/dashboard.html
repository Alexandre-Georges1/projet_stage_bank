 {% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="{% static 'css/dist/dashboard.css' %}?v=20250719190828">
    <link rel="stylesheet" href="{% static 'css/dist/tableau_de_bord.css' %}?v=20250719190828">
    <link rel="icon" type="image/x-icon" sizes="32x32" href="{% static 'favicon.ico' %}">
    <meta name="description" content="Gérez facilement votre parc informatique avec notre application PC pour entreprises. Suivi, maintenance et analyse en temps réel.">
    <title>Dashboard</title>
</head>
<body>
    <section id="sidebar">
        
        <div  class="brand">
            <div class="logo-container">
                <img loading="lazy" src="{% static 'logo_dashboard.png' %}" alt="Logo E-Machine - Gestion des PC" style="width: 60px; height: 60px;">
            </div>
            <h1 class="brand">E-Machine</h1>
        </div>
        <script>
        // Configuration des notifications pour la production
        window.notificationsData = [
          {% for notif in notifications %}
            {
              id: {{ notif.id_email|default:'null' }},
              type: "info",
              message: "{{ notif.objet|escapejs|truncatechars:50 }}",
              time: "{{ notif.date_envoi|date:'Y-m-d H:i:s' }}",
              sender_name: "{% if notif.expediteur %}{{ notif.expediteur.prenom }} {{ notif.expediteur.nom }}{% else %}Système{% endif %}",
              is_read: {% if notif.is_read %}true{% else %}false{% endif %}
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ];
        </script>
        <ul class="side-menu top">
{% block content %}
            <li class="active" id="dashboard-btn">
                    <i class='bx bxs-dashboard'></i>
                    <span class="text">Tableau de Bord</span>
            </li>  
            <li id="catalogue-ancien-btn">
                <i class="fas fa-folder"></i> 
                    <span class="text">Inventaire ordinateur ancien</span>
            </li>
            <li id="message-btn">
                    <i class='bx bxs-message-dots'></i>
                    <span class="text">Message</span>
            </li>
            <li id="equipe-btn" >
                    <i class='bx bxs-group'></i>
                    <span class="text">Équipe</span>
            </li>
            <li id="nouvel-employe-btn">
                    <i class='bx bxs-user-plus'></i>
                    <span class="text">Nouvel Employé</span>
            </li>
            <li id="received-characteristics-btn">
                <i class='bx bx-laptop'></i> 
                <span class="text">Caractéristiques Reçues</span>
            </li>
            <li id="parametre-btn">
                    <i class='bx bxs-cog' ></i>
                    <span class="text"> Parametre </span>
            </li>
            <li id="administration-btn">
                <i class='bx bxs-lock'></i>
                <span class="text">Administration</span>
            </li>
            <li id="Racheter-btn">
                <i class='bx bx-dollar-circle'></i> 
                <span class="text">Racheter votre PC</span>
            </li>
            <li id="Restituer-btn">
                <i class='bx bx-undo'></i> 
                <span class="text">Restituer votre PC</span>
            </li>
            <li id="bordereau-btn">
                <i class="fa-solid fa-file-contract"></i>
                    <span class="text"> Mon Bordereau</span>
            </li>
            <li id="lesdemandes-btn">
                <i class="fa-solid fa-history"></i>
                    <span class="text"> Les demandes de rachat </span>
            </li>
            <li id="Achat_piecevalider-btn">
                <i class="fa-solid fa-check-circle"></i>
                    <span class="text">les demandes d'achat</span>
            </li>
            <li id="Achat_piece-btn">
               <i class="fa-solid fa-computer-mouse"></i>
                    <span class="text">Demande d'achat de périphérique</span>
            </li>
        </ul>
            {% endblock %}
        <script>
      
        document.addEventListener('DOMContentLoaded', function() {
            // Ne considérer que les éléments mappés à des vues (suffixe -btn)
            var allMenu = Array.from(document.querySelectorAll('#sidebar .side-menu.top li[id]'));
            var menuItems = allMenu.filter(function(li){ return typeof li.id === 'string' && li.id.endsWith('-btn'); });
            var firstVisibleMenu = null;
            for (var i = 0; i < menuItems.length; i++) {
                var li = menuItems[i];
                if (li.offsetParent !== null) { // visible à l'écran
                    firstVisibleMenu = li;
                    break;
                }
            }
            if (firstVisibleMenu) {
                allMenu.forEach(function(li) { li.classList.remove('active'); });
                firstVisibleMenu.classList.add('active');
                document.querySelectorAll('main > div[id$="-view"]').forEach(function(view) {
                    view.classList.add('hidden');
                });
                var firstId = firstVisibleMenu.id.replace('-btn', '-view');
                var firstView = document.getElementById(firstId);
                if (firstView) {
                    firstView.classList.remove('hidden');
                }
            }
        });
        </script>
    </section>
    <section id="content">
        <nav>
            <i class='bx bx-menu' ></i>
            <form action="#" method="get">
            </form>
        <div class="user-profile-container">
            <div class="user-info-display" id="userInfoToggle" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
                <div class="user-text-info">
                    <div class="user-display-name">
                        {% if connected_user %}{{ connected_user.prenom }} {{ connected_user.nom }}{% else %}Utilisateur Inconnu{% endif %}
                    </div>
                    <div class="user-display-role">
                        {% if connected_user %}{{ connected_user.fonction }}{% else %}Rôle Inconnu{% endif %}
                    </div>
                </div>
                <div class="user-circle">
                    <span class="user-initials">
                        {% if connected_user %}{{ connected_user.prenom|first|upper }}{{ connected_user.nom|first|upper }}{% else %}??{% endif %}
                    </span>
                </div>
            </div>
            <!-- Dropdown d'information utilisateur -->
            <div class="user-info-dropdown" id="userInfoDropdown" aria-hidden="true">
                <div class="user-header">
                    <div class="user-avatar">
                        {% if connected_user %}{{ connected_user.prenom|first|upper }}{{ connected_user.nom|first|upper }}{% else %}??{% endif %}
                    </div>
                    <div class="user-details">
                        <div class="user-name">{% if connected_user %}{{ connected_user.prenom }} {{ connected_user.nom }}{% else %}Utilisateur Inconnu{% endif %}</div>
                        <div class="user-role">{% if connected_user %}{{ connected_user.fonction }}{% else %}Rôle Inconnu{% endif %}</div>
                    </div>
                </div>
                <div class="user-actions">
                    <button id="logoutAction" class="user-action-item logout-action">
                        <i class='bx bxs-log-out-circle'></i>
                        Se déconnecter
                    </button>
                </div>
            </div>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                var toggle = document.getElementById('userInfoToggle');
                var dropdown = document.getElementById('userInfoDropdown');
                if (!toggle || !dropdown) return;

                function closeDropdown(){
                    dropdown.classList.remove('show');
                    toggle.setAttribute('aria-expanded','false');
                    dropdown.setAttribute('aria-hidden','true');
                }
                function toggleDropdown(e){
                    e && e.stopPropagation();
                    var show = !dropdown.classList.contains('show');
                    dropdown.classList.toggle('show', show);
                    toggle.setAttribute('aria-expanded', show ? 'true' : 'false');
                    dropdown.setAttribute('aria-hidden', show ? 'false' : 'true');
                }
                toggle.addEventListener('click', toggleDropdown);
                toggle.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleDropdown(e);} });
                document.addEventListener('click', function(e){
                    if (!dropdown.contains(e.target) && !toggle.contains(e.target)) closeDropdown();
                });
                document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeDropdown(); });

                var logoutBtn = document.getElementById('logoutAction');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function(e){
                        e.preventDefault();
                        if (window.deconnexionUrl) {
                            window.location.href = window.deconnexionUrl;
                        } else {
                            alert('URL de déconnexion introuvable');
                        }
                    });
                }
            });
            </script>
        </div>
    <div class="notification-container">
        <button aria-label="Ouvrir les notifications" class="notification-btn" id="notificationBtn">
            <i class='bx bxs-bell'></i>
            <span class="notification-badge" id="notificationBadge">0</span>
        </button>
    <div class="notification-dropdown" id="notificationDropdown">
    <div class="notification-header">
        <span class="notification-title">Notifications</span>
        <button aria-label="Effacer toutes les notifications" class="clear-all" id="clearAllBtn">Tout effacer</button>
    </div>
    <div class="notification-list" id="notificationList">
        <!-- Inclusion dynamique avec JavaScript -->
    </div>   
        </nav>
        <main>
            <!-- Inclusion de toutes les vues du dashboard -->
            {% include 'dashboard_views.html' %}
        </main>
    </section>
    <!-- Inclusion de toutes les modales du dashboard -->
    {% include 'dashboard_modal.html' %}
    <script>
    window.demandeRachat="{% url 'demande_de_rachat'%}"
    window.ajouterPcUrl = "{% url 'ajouter_pc' %}";
    window.modifierPcUrl = "{% url 'modifier_pc' pc_id=0 %}";
    window.supprimerPcUrl = "{% url 'supprimer_pc' pc_id=0 %}";
    window.assignPcUrl = "{% url 'assign_pc_via_form' %}";
    window.modifierAttributionUrl = "{% url 'modifier_attribution' attribution_id=0 %}";
    window.supprimerAttributionUrl = "{% url 'supprimer_attribution' attribution_id=0 %}";
    window.changerPcAttributionUrl = "{% url 'changer_pc_attribution' attribution_id=0 %}";
    window.envoyercaracteristiquesUrl="{% url 'envoyer_caracteristiques' %}";
    window.demandeCaracteristiqueUrl="{% url 'demander_caracteristique' %}";
    window.deconnexionUrl = "{% url 'deconnexion' %}";
    window.connexionUrl= "{% url 'connexion' %}";
    window.addUserUrl = "{% url 'ajouter_utilisateur' %}";
    window.modifierUtilisateurUrl = "{% url 'modifier_utilisateur' user_id=0 %}";
    window.supprimerUtilisateurUrl = "{% url 'supprimer_utilisateur' user_id=0 %}";
    window.enregistrerEmployeUrl = "{% url 'enregistrer_employe' %}";
    
    // URL de notifications dynamique selon le rôle de l'utilisateur
    {% if connected_user.fonction == "DOT" %}
        window.getNotificationsUrl = "{% url 'get_notifications_dot' %}";
    {% elif connected_user.fonction == "RDOT" %}
        window.getNotificationsUrl = "{% url 'get_notifications_rdot' %}";
    {% elif connected_user.fonction == "DAF" %}
        window.getNotificationsUrl = "{% url 'get_notifications_daf' %}";
    {% elif connected_user.fonction == "MG" or connected_user.fonction == "RMG" %}
        window.getNotificationsUrl = "{% url 'get_notifications_mgx' %}";
    {% else %}
        window.getNotificationsUrl = "{% url 'get_notifications' %}";
    {% endif %}

    window.markNotificationAsReadUrl = "{% url 'mark_notification_as_read' email_id=0 %}";
    window.racheterPcUrl = "{% url 'racheter_pc' %}"; 
    window.envoyerBordereauEmployeUrl = "{% url 'envoyer_bordereau_employe' %}"; 
    window.validerOuRefuserPcUrl = "{% url 'valider_ou_refuser_pc' %}";
    window.restituerPcUrl = "{% url 'restituer_pc' %}";
    window.demandeAchatPeripheriquesUrl = "{% url 'demande_achat_peripheriques' %}";
    window.connectedUserFonction = "{{ connected_user.fonction|default:'' }}";
    window.ajouterPcAncienUrl = "{% url 'ajouter_pc_ancien' %}";
    window.assignPcAncienUrl = "{% url 'assign_pc_ancien' %}";
    window.modifierPcAncienUrl = "{% url 'modifier_pc_ancien' ancien_id=0 %}";
    window.supprimerPcAncienUrl = "{% url 'supprimer_pc_ancien' ancien_id=0 %}";
    </script>

<script src="{% static 'js/core/utilities.js' %}"></script>
<!-- Token CSRF caché pour JavaScript -->

<script src="{% static 'js/core/dashboard-core.js' %}"></script>
<script src="{% static 'js/core/notifications.js' %}"></script>
<script src="{% static 'js/modules/notification.js' %}"></script>
<script src="{% static 'js/modules/modal.js' %}"></script>
<script src="{% static 'js/modules/pc-management.js' %}"></script>
<script src="{% static 'js/modules/user-management.js' %}"></script>
<script src="{% static 'js/modules/rachat-management.js' %}"></script>
<script src="{% static 'js/modules/bordereau-management.js' %}"></script>
<script src="{% static 'js/modules/restitution-management.js' %}"></script>
<script src="{% static 'js/modules/achat-peripheriques-management.js' %}"></script>
<script src="{% static 'validation-demandes-management.js' %}"></script>
<script src="{% static 'js/modules/amortir.js' %}"></script>
<script src="{% static 'js/modules/pc-anciens-management.js' %}"></script>
<script src="{% static 'js/modules/table-search.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>
</body>
</html>